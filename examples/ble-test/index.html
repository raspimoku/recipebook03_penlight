<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BLE カラーピッカー テスト</title>
</head>
<body>
  <h2>BLE カラーピッカー テスト</h2>

  <div id="controls">
    <button onclick="connect()">接続</button>
    <button onclick="disconnect()">切断</button>
    <input type="color" id="colorPicker" onchange="sendColor()" disabled>
  </div>

  <p id="status">未接続</p>

  <script>
    // JavaScript <1>
    let device;
    let characteristic;

    // 接続処理 <2>
    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'SimpleBLE' }],
          optionalServices: ['12345678-1234-1234-1234-123456789abc']
        });

        device.ongattserverdisconnected = () => {
          document.getElementById("status").textContent = "切断されました";
          document.getElementById("colorPicker").disabled = true;
        };

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('12345678-1234-1234-1234-123456789abc');
        characteristic = await service.getCharacteristic('12345678-1234-1234-1234-123456789abd');

        document.getElementById("status").textContent = "接続中";
        document.getElementById("colorPicker").disabled = false;
      } catch (error) {
        console.error("接続エラー:", error);
        document.getElementById("status").textContent = "接続失敗";
      }
    }

    // 切断処理 <3>
    function disconnect() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
        document.getElementById("status").textContent = "切断しました";
        document.getElementById("colorPicker").disabled = true;
      }
    }

    // RGB 値送信処理 <4>
    async function sendColor() {
      if (!characteristic) return;

      const hex = document.getElementById('colorPicker').value;
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      await characteristic.writeValue(Uint8Array.of(r, g, b));
    }
  </script>
</body>
</html>